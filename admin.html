<script type="module">
    // 1. Importations
    import {initializeApp} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {getFirestore, collection, getDocs, doc, deleteDoc} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import * as XLSX from "https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.mjs";

    // 2. CONFIGURATION FIREBASE (REMETS TES CODES ICI !)
    const firebaseConfig = {
        apiKey: "AIzaSyAgO32iFQHG5LZPNRlPUbTmVef3bqs_5xk",
        authDomain: "dtm-ugb.firebaseapp.com",
        projectId: "dtm-ugb",
        storageBucket: "dtm-ugb.firebasestorage.app",
        messagingSenderId: "346661138136",
        appId: "1:346661138136:web:cf8e8196a65bda13e631ad",
        measurementId: "G-7ZVQ65D3RK"
    };

    // 3. Initialisation
    let app, db;
    try {
        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        console.log("Firebase connecté !");
    } catch (error) {
        console.error("Erreur Firebase:", error);
        alert("Erreur de connexion à la base de données. Vérifie la console (F12).");
    }

    // 4. RENDRE LES FONCTIONS GLOBALES (C'est ça qui manquait ou qui bloquait)
    window.verifyAdmin = verifyAdmin;
    window.delUser = delUser;
    window.exportXLSX = exportXLSX;
    window.postNews = postNews; // Si tu as ajouté la fonction postNews

    // --- FONCTION DE CONNEXION ---
    function verifyAdmin() {
        console.log("Tentative de connexion..."); // Pour vérifier si le bouton marche
        const pass = document.getElementById('adminPassword').value;

        if (pass === 'dtm2025') {
            document.getElementById('adminLogin').classList.add('hidden');
            document.getElementById('adminPanel').classList.remove('hidden');
            loadMembers(); // Charger les données
        } else {
            alert("Mot de passe incorrect !");
        }
    }

    // --- CHARGER LES MEMBRES ---
    async function loadMembers() {
        const tbody = document.getElementById('tbody');
        tbody.innerHTML = '<tr><td colspan="6" class="text-center p-4">Chargement...</td></tr>';

        try {
            const querySnapshot = await getDocs(collection(db, "membres"));
            document.getElementById('count').innerText = querySnapshot.size;
            tbody.innerHTML = '';

            querySnapshot.forEach((doc) => {
                const u = doc.data();
                const docId = doc.id;

                tbody.innerHTML += `
                    <tr class="hover:bg-gray-50 border-b">
                        <td class="px-4 py-3"><img src="${u.photo}" class="w-10 h-10 rounded-full object-cover"></td>
                        <td class="px-4 py-3">
                            <div class="font-bold text-black">${u.prenom} ${u.nom}</div>
                            <div class="text-xs text-gray-500">${u.id}</div>
                        </td>
                        <td class="px-4 py-3 text-xs">
                            <div>${u.telephone}</div>
                            <div class="truncate max-w-[120px]">${u.email}</div>
                        </td>
                        <td class="px-4 py-3">${u.specialite} (${u.niveau})</td>
                        <td class="px-4 py-3 text-dtm-primary font-medium">${u.poste}</td>
                        <td class="px-4 py-3 text-center">
                            <button onclick="delUser('${docId}')" class="text-red-500 hover:bg-red-100 p-2 rounded"><i class="fa-solid fa-trash"></i></button>
                        </td>
                    </tr>
                `;
            });
        } catch (e) {
            console.error("Erreur lecture:", e);
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-red-500 p-4">Erreur de chargement. Vérifie tes droits Firebase.</td></tr>';
        }
    }

    // --- SUPPRIMER UN MEMBRE ---
    async function delUser(docId) {
        if (confirm('Supprimer définitivement ?')) {
            try {
                await deleteDoc(doc(db, "membres", docId));
                loadMembers(); // Recharger la liste
            } catch (e) {
                alert("Erreur suppression: " + e.message);
            }
        }
    }

    // --- EXPORT EXCEL (.xlsx) ---
    async function exportXLSX() {
        try {
            const querySnapshot = await getDocs(collection(db, "membres"));
            if (querySnapshot.empty) {alert("Aucune donnée à exporter."); return;}

            let data = [];
            querySnapshot.forEach((doc) => {
                const u = doc.data();
                // On nettoie les données (pas de photo base64 car trop lourd pour Excel)
                data.push({
                    ID: u.id,
                    Prénom: u.prenom,
                    Nom: u.nom,
                    Email: u.email,
                    Téléphone: u.telephone,
                    Spécialité: u.specialite,
                    Niveau: u.niveau,
                    Poste: u.poste,
                    Date: u.date || ''
                });
            });

            const worksheet = XLSX.utils.json_to_sheet(data);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Membres DTM");
            XLSX.writeFile(workbook, "Membres_DTM.xlsx");
        } catch (e) {
            console.error(e);
            alert("Erreur export: " + e.message);
        }
    }

    // --- PUBLIER ACTUALITÉ (Optionnel si tu l'as gardé) ---
    // (Ajoute ta fonction postNews ici si besoin, similaire à l'étape précédente)

</script>
