<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mon Espace - DTM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script> tailwind.config = {theme: {extend: {colors: {dtm: {light: '#e0f2fe', primary: '#0284c7', dark: '#0c4a6e'}}}}} </script>
    <style>
        body {
            background-image: url('https://images.unsplash.com/photo-1638202993928-7267aad84c31?q=80&w=1920');
            background-size: cover;
            background-attachment: fixed;
            background-position: center;
        }

        .glass-overlay {
            background-color: rgba(255, 255, 255, 0.95);
            min-height: 100vh;
        }

        .fade-in {
            animation: fadeIn 0.8s ease-out forwards;
            opacity: 0;
            transform: translateY(20px);
        }

        @keyframes fadeIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body>
    <div class="glass-overlay">
        <nav class="bg-white/90 backdrop-blur shadow-sm border-b p-4 mb-8 sticky top-0 z-50">
            <div class="max-w-6xl mx-auto flex justify-between items-center px-4">
                <div class="flex items-center space-x-3">
                    <img src="logo.png" id="navLogo" class="h-16 w-auto"
                        onerror="this.src='https://cdn-icons-png.flaticon.com/512/1034/1034179.png'">
                    <span class="font-bold text-xl text-dtm-dark hidden sm:block">Mon Espace</span>
                </div>
                <button onclick="logout()"
                    class="text-red-500 border border-red-200 bg-white px-4 py-2 rounded-full hover:bg-red-50 text-sm font-bold transition-colors">
                    <i class="fa-solid fa-power-off mr-2"></i> Déconnexion
                </button>
            </div>
        </nav>

        <div class="max-w-6xl mx-auto px-6 pb-12 fade-in">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-10">

                <div class="bg-white rounded-3xl shadow-xl p-8 border border-gray-100 h-fit">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="font-bold text-2xl text-dtm-dark">Mes Informations</h3>
                        <button onclick="openEditModal()"
                            class="text-white bg-dtm-primary hover:bg-blue-600 px-4 py-2 rounded-lg text-sm font-bold transition-colors shadow-md">
                            <i class="fa-solid fa-pen-to-square mr-2"></i> Modifier
                        </button>
                    </div>
                    <div id="userInfo" class="space-y-4 text-gray-700"></div>
                </div>

                <div class="flex flex-col items-center bg-white rounded-3xl shadow-xl p-8 border border-gray-100">
                    <h3 class="font-bold text-xl mb-6 text-dtm-dark text-center w-full border-b pb-4">Ma Carte Numérique
                    </h3>

                    <div id="id-card-wrapper" class="p-2 bg-white rounded-xl">
                        <div id="id-card"
                            class="relative w-[350px] h-[220px] bg-white rounded-xl shadow-md overflow-hidden flex border border-gray-200">
                            <div
                                class="absolute right-0 top-0 h-full w-2/3 bg-gradient-to-l from-dtm-light to-transparent opacity-60">
                            </div>
                            <div class="absolute -left-10 -bottom-10 w-40 h-40 bg-dtm-dark rounded-full opacity-10">
                            </div>

                            <div class="w-1/3 bg-dtm-dark flex flex-col items-center justify-center p-2 z-10 relative">
                                <div
                                    class="w-20 h-20 rounded-full border-2 border-white overflow-hidden bg-gray-300 mb-2 shadow-lg">
                                    <img id="cardPhoto" src="" class="w-full h-full object-cover"
                                        crossorigin="anonymous">
                                </div>
                                <div class="text-center">
                                    <p class="text-[9px] text-gray-300 uppercase tracking-widest mb-1">Membre</p>
                                    <p id="cardId"
                                        class="text-xs text-white font-mono font-bold bg-white/10 px-2 py-0.5 rounded">
                                        DTM-000</p>
                                </div>
                            </div>

                            <div class="w-2/3 p-4 flex flex-col justify-between z-10 relative">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <h4 class="text-xs font-extrabold text-dtm-primary uppercase tracking-tight">
                                            Dahira Touba Médecine</h4>
                                        <p class="text-[8px] text-gray-500 font-semibold">Université Gaston Berger</p>
                                    </div>
                                    <img id="cardLogoInternal" src="" class="w-12 h-12 object-contain drop-shadow-sm">
                                </div>
                                <div class="mt-2">
                                    <h2 id="cardName" class="text-sm font-bold text-gray-900 leading-tight">Prénom Nom
                                    </h2>
                                    <p id="cardRole" class="text-xs text-dtm-primary font-bold mt-1">Commission</p>
                                </div>
                                <div class="space-y-1 mt-2">
                                    <div class="flex items-center text-[10px] text-gray-600 font-medium"><i
                                            class="fa-solid fa-graduation-cap w-4 text-dtm-primary mr-1"></i> <span
                                            id="cardSpec">Spec</span></div>
                                    <div class="flex items-center text-[10px] text-gray-600 font-medium"><i
                                            class="fa-solid fa-phone w-4 text-dtm-primary mr-1"></i> <span
                                            id="cardTel">Tel</span></div>
                                </div>
                                <div
                                    class="w-full h-1.5 bg-gradient-to-r from-dtm-primary to-dtm-dark mt-3 rounded-full">
                                </div>
                            </div>
                        </div>
                    </div>

                    <button id="downloadBtn" onclick="downloadCard()"
                        class="mt-6 w-full max-w-[350px] bg-dtm-dark hover:bg-gray-800 text-white font-bold py-3 rounded-xl shadow-lg transition-transform hover:scale-[1.02] flex items-center justify-center">
                        <i class="fa-solid fa-download mr-2"></i> Télécharger la carte
                    </button>
                    <p id="downloadMsg" class="text-xs text-gray-400 mt-2 text-center hidden">Traitement en cours...</p>
                </div>
            </div>
        </div>
    </div>

    <div id="editModal" class="fixed inset-0 z-[60] hidden">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onclick="closeEditModal()"></div>
        <div
            class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full max-w-lg bg-white rounded-2xl p-8 shadow-2xl h-auto max-h-[90vh] overflow-y-auto">
            <h3 class="text-2xl font-bold mb-6 text-dtm-dark">Modifier mon profil</h3>
            <form onsubmit="saveChanges(event)" class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-xs font-bold text-gray-500">Prénom</label><input type="text" id="editPrenom"
                            class="w-full border rounded-lg p-3 bg-gray-50"></div>
                    <div><label class="text-xs font-bold text-gray-500">Nom</label><input type="text" id="editNom"
                            class="w-full border rounded-lg p-3 bg-gray-50"></div>
                </div>
                <div><label class="text-xs font-bold text-gray-500">Email</label><input type="email" id="editEmail"
                        class="w-full border rounded-lg p-3 bg-gray-50"></div>
                <div><label class="text-xs font-bold text-gray-500">Téléphone</label><input type="tel" id="editTel"
                        class="w-full border rounded-lg p-3 bg-gray-50"></div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs font-bold text-gray-500">Spécialité</label>
                        <select id="editSpec" class="w-full border rounded-lg p-3 bg-gray-50">
                            <option>Médecine</option>
                            <option>Pharmacie</option>
                            <option>Odontologie</option>
                            <option>Soins Infirmiers</option>
                            <option>Sage-femme</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-500">Niveau</label>
                        <select id="editNiv" class="w-full border rounded-lg p-3 bg-gray-50">
                            <option>L1</option>
                            <option>L2</option>
                            <option>L3</option>
                            <option>M1</option>
                            <option>M2</option>
                            <option>Doctorat</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-500">Poste / Commission</label>
                    <select id="editPoste" class="w-full border rounded-lg p-3 bg-gray-50">
                        <option>Membre simple</option>
                        <option>Communication</option>
                        <option>Social</option>
                        <option>Pédagogique</option>
                        <option>Organisation</option>
                    </select>
                </div>

                <div class="flex justify-end gap-3 mt-8">
                    <button type="button" onclick="closeEditModal()"
                        class="px-6 py-3 text-gray-500 hover:bg-gray-100 rounded-lg font-bold">Annuler</button>
                    <button type="submit"
                        class="px-6 py-3 bg-dtm-primary hover:bg-blue-600 text-white rounded-lg font-bold shadow-lg">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // --- 1. CHARGEMENT DONNEES ---
        let currentUser = JSON.parse(localStorage.getItem('dtm_currentUser'));
        if (!currentUser) window.location.href = "connexion.html";

        // --- 2. ASTUCE LOGO (Pour éviter le blocage de sécurité) ---
        // On charge le logo localement et on le met en Base64 dans la carte
        function loadLogoSafe() {
            const img = new Image();
            img.src = 'logo.png';
            img.onload = function () {
                const canvas = document.createElement('canvas');
                canvas.width = img.width;
                canvas.height = img.height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0);
                // On remplace la source de l'image interne par la version Base64 "sûre"
                document.getElementById('cardLogoInternal').src = canvas.toDataURL('image/png');
            };
            img.onerror = function () {
                // Fallback si pas de logo
                document.getElementById('cardLogoInternal').style.display = 'none';
            }
        }
        loadLogoSafe(); // Lancer au démarrage

        renderPage();

        function renderPage() {
            // Infos
            document.getElementById('userInfo').innerHTML = `
                <div class="space-y-3">
                    <div class="flex justify-between border-b pb-2"><span class="text-gray-500">Matricule</span> <span class="font-mono font-bold text-dtm-primary">${currentUser.id}</span></div>
                    <div class="flex justify-between border-b pb-2"><span class="text-gray-500">Nom complet</span> <span class="font-medium">${currentUser.prenom} ${currentUser.nom}</span></div>
                    <div class="flex justify-between border-b pb-2"><span class="text-gray-500">Email</span> <span class="font-medium">${currentUser.email}</span></div>
                    <div class="flex justify-between border-b pb-2"><span class="text-gray-500">Téléphone</span> <span class="font-medium">${currentUser.telephone}</span></div>
                    <div class="flex justify-between border-b pb-2"><span class="text-gray-500">Cursus</span> <span class="font-medium">${currentUser.specialite} (${currentUser.niveau})</span></div>
                    <div class="flex justify-between border-b pb-2"><span class="text-gray-500">Poste</span> <span class="font-medium text-dtm-primary">${currentUser.poste}</span></div>
                </div>
            `;
            // Carte
            document.getElementById('cardName').innerText = `${currentUser.prenom} ${currentUser.nom}`;
            document.getElementById('cardRole').innerText = currentUser.poste;
            document.getElementById('cardSpec').innerText = `${currentUser.specialite} - ${currentUser.niveau}`;
            document.getElementById('cardTel').innerText = currentUser.telephone;
            document.getElementById('cardId').innerText = currentUser.id;
            document.getElementById('cardPhoto').src = currentUser.photo;
        }

        // --- 3. FONCTION DE TÉLÉCHARGEMENT ROBUSTE ---
        function downloadCard() {
            const card = document.getElementById("id-card");
            const btn = document.getElementById("downloadBtn");
            const msg = document.getElementById("downloadMsg");

            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i> Génération...';
            msg.classList.remove('hidden');

            // Petite pause pour laisser le temps au DOM de se préparer
            setTimeout(() => {
                html2canvas(card, {
                    scale: 3, // Haute qualité
                    useCORS: true, // Autorise les images externes
                    allowTaint: true, // Autorise les images locales
                    backgroundColor: null,
                    logging: false
                }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `Carte_DTM_${currentUser.prenom}_${currentUser.nom}.png`;
                    link.href = canvas.toDataURL("image/png");
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                    // Reset bouton
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fa-solid fa-download mr-2"></i> Télécharger la carte';
                    msg.classList.add('hidden');
                }).catch(err => {
                    console.error("Erreur capture:", err);
                    alert("Erreur de sécurité navigateur.\n\nSolution : Essayez d'utiliser un autre navigateur (Firefox) ou assurez-vous que 'logo.png' est bien dans le dossier.");
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fa-solid fa-triangle-exclamation mr-2"></i> Erreur';
                });
            }, 500);
        }

        // --- 4. GESTION MODAL ET MODIFS ---
        function openEditModal() {
            document.getElementById('editPrenom').value = currentUser.prenom;
            document.getElementById('editNom').value = currentUser.nom;
            document.getElementById('editEmail').value = currentUser.email;
            document.getElementById('editTel').value = currentUser.telephone;
            document.getElementById('editSpec').value = currentUser.specialite;
            document.getElementById('editNiv').value = currentUser.niveau;
            document.getElementById('editPoste').value = currentUser.poste;
            document.getElementById('editModal').classList.remove('hidden');
        }
        function closeEditModal() {document.getElementById('editModal').classList.add('hidden');}

        function saveChanges(e) {
            e.preventDefault();
            currentUser.prenom = document.getElementById('editPrenom').value;
            currentUser.nom = document.getElementById('editNom').value;
            currentUser.email = document.getElementById('editEmail').value;
            currentUser.telephone = document.getElementById('editTel').value;
            currentUser.specialite = document.getElementById('editSpec').value;
            currentUser.niveau = document.getElementById('editNiv').value;
            currentUser.poste = document.getElementById('editPoste').value;

            let users = JSON.parse(localStorage.getItem('dtm_users'));
            const index = users.findIndex(u => u.id === currentUser.id);
            if (index !== -1) {
                users[index] = currentUser;
                localStorage.setItem('dtm_users', JSON.stringify(users));
                localStorage.setItem('dtm_currentUser', JSON.stringify(currentUser));
                renderPage();
                closeEditModal();
                alert("Profil mis à jour !");
            }
        }

        function logout() {localStorage.removeItem('dtm_currentUser'); window.location.href = "index.html";}
    </script>
</body>

</html>